<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily ShipStation Leaderboard</title>
<style>
    :root{
      --rco-cream:#d7d1ca;
      --rco-stone:#d6d1c3;
      --rco-taupe:#8d8173;
      --rco-brown:#5f4b3c;
      --rco-charcoal:#25282a;
      --rco-soft-camel:#bd9979;
      --tan-light:var(--rco-cream);
      --tan-dark:var(--rco-brown);
      --card-bg: rgba(255,255,255,0.98);
    }
    
    html, body{
      height:100%;
      margin:0;
      font-family:"Avenir Next", Avenir, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background:#f5f5f5;
      color:var(--rco-charcoal);
      overflow: hidden;
    }

    .dashboard-container {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 16px;
    }

    .dashboard-header {
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(95, 75, 60, 0.08);
      flex-shrink: 0;
      position: relative;
    }

    .header-title {
      font-size: clamp(1.2em, 3vw, 1.5em);
      font-weight: 600;
      color: #5f4b3c;
      font-family: "Noto Serif", Georgia, "Times New Roman", Times, serif;
      text-align: center;
    }

    .header-subtitle {
      font-size: clamp(0.85em, 1.8vw, 1em);
      color: var(--rco-taupe);
      margin-top: 4px;
      font-weight: 600;
      text-align: center;
    }

    .boards-container {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      min-height: 0;
    }

    .board-card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(95, 75, 60, 0.08);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .board-header {
      padding: 16px;
      color: #fff;
      font-weight: 700;
      text-align: center;
      font-size: clamp(0.9em, 2vw, 1.1em);
      background: linear-gradient(135deg, #d7d1ca 0%, #bd9979 100%);
    }

    .board-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 0;
      background: #fbfaf8;
    }

    .table-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .header-table {
      width: 100%;
      border-collapse: collapse;
      flex-shrink: 0;
      table-layout: fixed;
    }

    .header-table thead th {
      padding: clamp(8px, 1.5vw, 10px) 4px;
      text-align: center;
      font-weight: 700;
      color: white;
      background: var(--tan-dark);
      font-size: clamp(9.5px, 1.05vw, 13.5px);
      white-space: nowrap;
      box-sizing: border-box;
      line-height: 1.2;
    }

    .scroll-wrapper {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .scroll-content {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      will-change: transform;
    }

    .body-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .body-table tbody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }

    .body-table td {
      padding: clamp(8px, 1.5vw, 10px) 4px;
      text-align: center;
      border-bottom: 1px solid rgba(141,129,115,0.12);
      vertical-align: middle;
      font-size: clamp(11px, 1.2vw, 15px);
      color: var(--rco-charcoal);
      box-sizing: border-box;
      overflow-wrap: break-word;
    }

    .medal-gold td,
    .medal-silver td,
    .medal-bronze td {
      font-weight: 700;
      background: transparent;
      color: var(--rco-charcoal);
      border-top: none;
      border-left: none;
      border-right: none;
    }

    .medal-gold td {
      border-bottom: 3px solid var(--rco-brown);
    }

    .medal-silver td {
      border-bottom: 3px solid var(--rco-soft-camel);
    }

    .medal-bronze td {
      border-bottom: 3px solid #fbfaf8;
    }

    .col-rank {
      font-size: clamp(13px, 1.4vw, 17px);
      font-weight: 700;
      width: 10%;
    }

    .col-employee {
      text-align: center;
      padding-left: 4px;
      padding-right: 4px;
      font-size: clamp(11px, 1.2vw, 15px);
      font-weight: 600;
      white-space: normal;
      word-wrap: break-word;
      width: 32%;
      line-height: 1.3;
    }

    .col-prod {
      font-size: clamp(11px, 1.2vw, 15px);
      font-weight: 600;
      width: 19%;
    }

    .col-orders {
      font-size: clamp(11px, 1.2vw, 15px);
      font-weight: 600;
      width: 17%;
    }

    .col-avg {
      font-size: clamp(10px, 1.1vw, 13px);
      font-weight: 600;
      width: 22%;
    }

    .body-table tbody tr:nth-child(odd) td {
      background: #ffffff;
    }

    .body-table tbody tr:nth-child(even) td {
      background: #fbfaf8;
    }

    .empty {
      color: var(--rco-taupe);
      padding: 20px;
      text-align: center;
      font-style: italic;
    }

    .notice {
      grid-column: 1/-1;
      padding: clamp(12px, 2vw, 20px);
      border-radius: 12px;
      background: white;
      color: var(--tan-dark);
      text-align: center;
      box-shadow: 0 2px 8px rgba(95, 75, 60, 0.08);
    }

    /* RESPONSIVE */
    @media (max-width: 1100px) {
      .boards-container {
        grid-template-columns: 1fr;
      }

      .board-card {
        min-height: 500px;
      }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 12px;
        gap: 12px;
      }

      .dashboard-header {
        padding: 12px 16px;
      }

      .header-title {
        font-size: 1.2em;
      }

      .header-subtitle {
        font-size: 0.85em;
      }

      .board-card {
        min-height: 450px;
      }
    }

    @media (max-width: 480px) {
      .dashboard-container {
        padding: 10px;
        gap: 10px;
      }

      .header-title {
        font-size: 1em;
      }

      .header-subtitle {
        font-size: 0.75em;
      }

      .board-card {
        min-height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div>
        <div class="header-title">üöö Today's Shipping Leaderboard</div>
        <div id="weekRange" class="header-subtitle">Week: loading‚Ä¶</div>
      </div>
    </div>

    <div id="boards" class="boards-container" aria-live="polite">
      <div class="notice">Loading data...</div>
    </div>
  </div>

<script>
(async function(){
  const SHEET_ID = '1-S1OU7nw_085IXVbfiOY5qDPuRcPx2RqQJg8pnOqU9I';
  const GID = '165470098';
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

  function parseCSV(text){
    const rows = [];
    const lines = text.replace(/\r\n/g,'\n').split('\n');
    for(const line of lines){
      const row = [];
      let cur = '';
      let inQuotes = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"' ){
          if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
          inQuotes = !inQuotes;
          continue;
        }
        if(ch === ',' && !inQuotes){
          row.push(cur);
          cur = '';
          continue;
        }
        cur += ch;
      }
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  async function fetchCSV(){
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error('Failed to load sheet ‚Äî make sure it is published. Status: '+res.status);
    const txt = await res.text();
    return parseCSV(txt);
  }

  function findMeta(grid){
    for(let r=0;r<8 && r<grid.length;r++){
      const text = (grid[r] || []).join(' ').trim();
      if(!text) continue;
      if(/week[:\s]/i.test(text) || /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/i.test(text)){
        return {row:r, text};
      }
    }
    return null;
  }

  function findRankHeaders(grid){
    const headers = [];
    for(let r=0;r<12 && r<grid.length;r++){
      for(let c=0;c<(grid[r]||[]).length;c++){
        const cell = ((grid[r]||[])[c]||'').toString().trim().toLowerCase();
        if(cell === 'rank') headers.push({row:r,col:c});
      }
    }
    return headers;
  }

  function extractBlock(grid, header){
    const out = [];
    const start = header.row + 1;
    const col = header.col;
    let empties = 0;
    for(let r=start;r<grid.length;r++){
      const row = grid[r] || [];
      const rank = (row[col] || '').toString().trim();
      const employee = (row[col+1] || '').toString().trim();
      const products = (row[col+2] || '').toString().trim();
      const orders = (row[col+3] || '').toString().trim();
      const avg = (row[col+4] || '').toString().trim();
      if(!rank && !employee && !products && !orders && !avg){ 
        empties++; 
        if(empties>=3) break; 
        else continue; 
      }
      if(employee && (products || orders)) {
        out.push({rank, employee, products, orders, avg});
      }
    }
    return out;
  }

  function nice(x){ 
    if(!x) return ''; 
    const n = Number(x.toString().replace(/[,]/g,'')); 
    return Number.isFinite(n) ? n.toLocaleString() : x; 
  }

  function buildCard(title, rows){
    const head = `<div class="board-header">${title.toUpperCase()}</div>`;
    
    const validRows = rows.filter(r => {
      const hasEmployee = r.employee && r.employee.trim() !== '';
      const hasOrders = r.orders && r.orders !== '0' && r.orders.trim() !== '';
      const hasProducts = r.products && r.products !== '0' && r.products.trim() !== '';
      return hasEmployee && (hasOrders || hasProducts);
    });
    
    if(!validRows || validRows.length === 0) {
      return `<div class="board-card" style="display:none;" data-category="${title}"></div>`;
    }
    
    const rowsHtml = validRows.map((r,idx)=>{
      const cls = idx===0? 'medal-gold' : idx===1? 'medal-silver' : idx===2? 'medal-bronze' : '';
      const displayRank = (idx + 1).toString();
      const fullName = (r.employee || '').trim();
      let employeeName = fullName;
      if(fullName.length > 15) {
        const nameParts = fullName.split(/\s+/);
        if(nameParts.length >= 2) {
          const firstName = nameParts.slice(0, -1).join(' ');
          const lastName = nameParts[nameParts.length - 1];
          employeeName = `${firstName}<br>${lastName}`;
        }
      }
      return `<tr class="${cls}"><td class="col-rank">${displayRank}</td><td class="col-employee">${employeeName}</td><td class="col-prod">${nice(r.products)}</td><td class="col-orders">${nice(r.orders)}</td><td class="col-avg">${r.avg||''}</td></tr>`;
    }).join('');
    
    return `
      <div class="board-card" data-category="${title}">
        ${head}
        <div class="board-body">
          <div class="table-container">
            <table class="header-table">
              <thead>
                <tr>
                  <th class="col-rank">Rank</th>
                  <th class="col-employee">Employee</th>
                  <th class="col-prod">Products</th>
                  <th class="col-orders">Orders</th>
                  <th class="col-avg">Avg<br>Item/Order</th>
                </tr>
              </thead>
            </table>
            <div class="scroll-wrapper">
              <div class="scroll-content">
                <table class="body-table">
                  <tbody>${rowsHtml}</tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }

  try{
    const raw = await fetchCSV();
    
    const meta = findMeta(raw);
    if(meta) {
      document.getElementById('weekRange').textContent = meta.text.replace(/\s{2,}/g,' ').trim();
    }

    const headers = findRankHeaders(raw);
    
    let chosen = headers.slice(0,3);
    if(chosen.length < 3){
      const fallback = [{row:3,col:1},{row:3,col:7},{row:3,col:13}];
      chosen = fallback.slice(0,3);
    }

    chosen.sort((a,b)=>a.col - b.col);

    const cats = ['Full-time','Part-Time','Wholesale'];
    const boards = document.getElementById('boards');
    boards.innerHTML = '';

    for(let i=0;i<3;i++){
      const h = chosen[i];
      const rows = h ? extractBlock(raw,h) : [];
      boards.insertAdjacentHTML('beforeend', buildCard(cats[i], rows));
    }
    
    const visibleCards = boards.querySelectorAll('.board-card:not([style*="display:none"])');
    if(visibleCards.length === 2) {
      boards.style.gridTemplateColumns = 'repeat(2, 1fr)';
    } else if(visibleCards.length === 1) {
      boards.style.gridTemplateColumns = '1fr';
      visibleCards[0].style.maxWidth = '800px';
      visibleCards[0].style.margin = '0 auto';
    }

    function startAutoScrollWhenReady() {
      let startedAny = false;

      document.querySelectorAll('.scroll-wrapper').forEach(wrapper => {
        if (wrapper.dataset.started) return;

        const scrollContent = wrapper.querySelector('.scroll-content');
        if (!scrollContent) return;

        const wrapperHeight = wrapper.getBoundingClientRect().height;
        const contentHeight = scrollContent.getBoundingClientRect().height;

        if (wrapperHeight === 0 || contentHeight === 0) return;
        if (contentHeight <= wrapperHeight) return;

        wrapper.dataset.started = 'true';
        startedAny = true;

        let position = 0;
        let direction = 1;
        const scrollSpeed = 30;
        const maxScroll = contentHeight - wrapperHeight;
        const pauseDuration = 2500;
        let lastTime = performance.now();
        let isPaused = false;
        let pauseStartTime = 0;

        function animate(currentTime) {
          if (isPaused) {
            if (currentTime - pauseStartTime >= pauseDuration) {
              isPaused = false;
              lastTime = currentTime;
            } else {
              requestAnimationFrame(animate);
              return;
            }
          }

          const deltaTime = (currentTime - lastTime) / 1000;
          lastTime = currentTime;

          position += scrollSpeed * deltaTime * direction;

          if (direction === 1 && position >= maxScroll) {
            position = maxScroll;
            direction = -1;
            isPaused = true;
            pauseStartTime = currentTime;
          } else if (direction === -1 && position <= 0) {
            position = 0;
            direction = 1;
            isPaused = true;
            pauseStartTime = currentTime;
          }

          scrollContent.style.transform = `translateY(-${position}px)`;
          requestAnimationFrame(animate);
        }

        requestAnimationFrame(animate);
      });

      if (!startedAny) {
        requestAnimationFrame(startAutoScrollWhenReady);
      }
    }

    requestAnimationFrame(startAutoScrollWhenReady);

  } catch(err){
    console.error(err);
    document.getElementById('boards').innerHTML = `<div class="notice">‚ö†Ô∏è Error loading data: ${err.message}<br><br>Make sure the Google Sheet is published to web</div>`;
  }
})();
</script>
</body>
</html>
